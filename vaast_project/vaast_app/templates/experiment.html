<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAAT Experiment</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Arial', sans-serif;
            background: #f0f0f0;
        }
        h1 {
            position: fixed;
            top: 20px;
            font-size: 36px;
            color: #333;
            margin: 0;
        }
        #intro {
            text-align: center;
            padding: 20px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        #word-container {
            display: none;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        .word {
            font-size: 80px;
            text-align: center;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 400px;
            height: 200px;
        }
        .word-smaller {
            font-size: 50px;
            text-align: center;
            padding: 20px;
            transition: font-size 0.5s ease, width 0.5s ease, height 0.5s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 400px;
            height: 200px;
        }
        .word-bigger {
            font-size: 140px;
            text-align: center;
            padding: 20px;
            transition: font-size 0.5s ease, width 0.5s ease, height 0.5s ease;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 400px;
            height: 200px;
        }
        .word:not(.word-bigger),
        .word:not(.word-smaller) {
            transition: none; /* Disable transitions when switching off */
        }
    </style>
</head>
<body>
    <h1>MAAT Experiment</h1>
    <div id="intro" class="screen">
        <p>Please enter your Participant ID:</p>
        <input type="text" id="participant-id-input">
        <button onclick="showIntro()">Start Experiment</button>
    </div>
    <div id="word-container" class="screen">
        <div class='word' id="word"></div>
    </div>

    <script>
const words = {{ words|safe }};
const word_ids = {{ word_ids|safe }};

const aspectRatio = 5;
let currentWordIndex = -1;
let fontSize = 50;
let startTime;
let reactions = [];
let experimentId = 1;
let participantId;
let experimentStarted = false;

const introElement = document.getElementById('intro');
const wordContainer = document.getElementById('word-container');
const wordElement = document.getElementById('word');

function displayWord() {
    currentWordIndex++;
    if (currentWordIndex < words.length) {
        wordElement.textContent = words[currentWordIndex];
    } else {
        wordElement.textContent = 'Experiment Complete';
        wordContainer.style.display = 'none'; // Hide word container
        document.removeEventListener('keydown', handleKeyPress); // Remove the event listener
        showExperimentCompleteScreen(); // Show experiment complete screen
        return;
    }
}

async function startExperiment() {
    experimentStarted = true;
    // Reset the displayed word to '+' and display it
    introElement.style.display = 'none';
    wordContainer.style.display = 'flex';

    wordElement.fontSize = fontSize + 'px';
    wordElement.textContent = '+';

    // Wait for 2 seconds
    await delay(2000);

    startTime = performance.now();
    displayWord();
    document.addEventListener('keydown', handleKeyPress);
}

async function updateFontSize(event) {
    if (event.key === 'y') {
        wordElement.classList.remove('word');
        wordElement.classList.add('word-bigger');
        
    } else if (event.key === 'n') {
        wordElement.classList.remove('word');
        wordElement.classList.add('word-smaller');
    }
}

function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

async function handleKeyPress(event) {
    if (!experimentStarted) {
        document.removeEventListener('keydown', handleKeyPress)
        startExperiment();
        return;
    }

    let reactionTime = performance.now() - startTime; // Calculate reaction time
    document.removeEventListener('keydown', handleKeyPress);

    await updateFontSize(event);
    await delay(2000);

    let reaction = {
        word: word_ids[currentWordIndex],
        key: event.key,
        reaction_time: reactionTime // Round to 2 decimal places
    };
    reactions.push(reaction); // Store reaction data
    
    // Reset the displayed word to '+' and display it
    wordElement.textContent = '+';
    
    wordElement.classList.remove('word-smaller');
    wordElement.classList.remove('word-bigger');
    wordElement.classList.add('word'); // Reset to the original class

    // Wait for 3 seconds
    await delay(2000);

    // Then display the next word
    
    document.addEventListener('keydown', handleKeyPress)
    displayWord();

    startTime = performance.now();
}

function showExperimentCompleteScreen() {
    const completeScreen = document.createElement('div');
    console.log(reactions);
    completeScreen.className = 'intro';
    completeScreen.innerHTML = `
        <p>Experiment Complete</p>
        <p>Thank you for participating!</p>
        <button onclick="downloadCSV()">Download CSV File</button>
    `;
    document.body.appendChild(completeScreen);
    createTrial();
}

function convertToCSV(objArray) {
    const array = typeof objArray !== 'object' ? JSON.parse(objArray) : objArray;
    let str = '';

    // Add headers
    let header = '';
    for (let index in array[0]) {
        if (header !== '') header += ',';
        header += index;
    }
    str += header + '\r\n';

    // Add rows
    for (let i = 0; i < array.length; i++) {
        let line = '';
        for (let index in array[i]) {
            if (line !== '') line += ',';
            line += array[i][index];
        }
        str += line + '\r\n';
    }
    return str;
}

// Add the keydown event listener to start the experiment

        function downloadCSV(){
            // Convert reactions to CSV string
            const csvString = convertToCSV(reactions);

            // Create a Blob from the CSV string
            const blob = new Blob([csvString], { type: 'text/csv' });

            // Create a link element
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'reactions.csv';

            // Append the link to the document body (necessary for Firefox)
            document.body.appendChild(link);

            // Programmatically click the link to trigger the download
            link.click();

            // Remove the link from the document
            document.body.removeChild(link);
        };
        function createTrial() {

            fetch('/create_trial/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    experiment: 1,
                    participant_id: participantId,
                    responses: reactions 
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('Trial created successfully: ' + data.trial_id);
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }
        function showIntro() {
            document.addEventListener('keydown', handleKeyPress);
            const element = document.getElementById('intro')
            participantId = document.getElementById('participant-id-input').value
            element.innerHTML = `
            <p>Welcome to the VAAST Experiment</p>
            {% if instructions is not none %}
             <p>{{ instructions }}</p>
            {% endif %}
            <p><strong>Press any key to begin</strong><p>
        `
        }


    </script>
</body>

</html>
